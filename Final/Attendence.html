<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance Module (Fixed)</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background:#f0f2f5; color:#1c1e21; margin:0; padding:24px }
    .container { max-width:1200px; margin:auto; background:#fff; padding:24px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1) }
    h2{ color:#0d6efd; border-bottom:2px solid #f0f2f5; padding-bottom:12px; margin-top:0 }
    .toolbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
    select,input,button{ padding:8px 12px; border:1px solid #ccc; border-radius:6px; font-size:14px }
    button{ background:#0d6efd; color:#fff; border:none; cursor:pointer }
    button:hover{ filter:brightness(.95) }
    .btn-danger{ background:#dc3545 }
    table{ width:100%; border-collapse:collapse; margin-top:20px }
    th,td{ text-align:left; padding:12px; border-bottom:1px solid #ddd }
    th{ background:#f8f9fa }
    .status{ padding:4px 8px; border-radius:12px; font-size:12px; font-weight:600; color:#fff }
    .status-present{ background:#198754 }
    .status-absent{ background:#dc3545 }
    .status-late{ background:#fd7e14 }
    .status-excused{ background:#6c757d }
    .actions button{ padding:6px 10px; margin-right:6px }

    /* modal simple styles */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center }
    .modal.show{ display:flex }
    .modal-card{ background:#fff; width:95%; max-width:800px; border-radius:8px; padding:20px }
    .student-row{ display:flex; align-items:center; gap:12px; margin-bottom:8px }
    .student-row label{ min-width:180px }
  </style>
</head>
<body>
  <div class="container">

    <nav style="background:#0d6efd; padding:12px; border-radius:8px; margin-bottom:20px; display:flex; gap:15px; flex-wrap:wrap;">
    <a href="Student Directory.html" style="color:white; text-decoration:none; ">üè´ Student Directory</a> 
    <a href="Subject manager.html" style="color:white; text-decoration:none;">üìö Subject Manager</a>
    <a href="Syllabus_progress.html" style="color:white; text-decoration:none;  ">üìä Syllabus Progress</a>
    <a href="workpool.html" style="color:white; text-decoration:none; ">üìù Work Pool</a>
    <a href="Dought Task.html" style="color:white; text-decoration:none;">‚ùì Doubt Box</a>
    <a href="Test Treacker.html" style="color:white; text-decoration:none; ">üìò Test Tracker</a>
    <a href="Attendence.html" style="color:white; text-decoration:none; font-weight:bold;">üìÖ Attendance</a>
</nav>

    <div class="toolbar">
      <h2>üìÖ Attendance Tracker</h2>
      <div>
        <label for="batchFilter"><b>Batch</b></label>
        <select id="batchFilter"><option value="">All Batches</option></select>
        <label for="dateFilter"><b>Date</b></label>
        <input id="dateFilter" type="date" />
        <button id="markAttendanceBtn">Mark Attendance</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Batch</th>
          <th>Student</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="attendanceList"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="attendanceModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3 id="modalTitle">Mark Attendance</h3>
      <form id="attendanceForm">
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap">
          <div>
            <label for="batchSelect">Batch</label><br>
            <input id="batchSelect" type="text" placeholder="Enter Batch Name" required />
          </div>
          <div>
            <label for="dateSelect">Date</label><br>
            <input id="dateSelect" type="date" required />
          </div>
        </div>

        <div>
          <label style="font-weight:700">Students</label>
          <div id="studentList" style="margin-top:8px"></div>
        </div>

        <div style="text-align:right; margin-top:18px">
          <button type="button" id="closeModal" class="btn-secondary">Cancel</button>
          <button type="submit">Save Attendance</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, doc, getDoc, query, where, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // --- config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOhbm4Hgg0fhcomZfp-BpC6jfeAsshuF8",
      authDomain: "edudashboard-65a9f.firebaseapp.com",
      projectId: "edudashboard-65a9f",
      storageBucket: "edudashboard-65a9f.firebasestorage.app",
      messagingSenderId: "1007330679468",
      appId: "1:1007330679468:web:97cff4a762e9fd9df51d09"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM
    const attendanceList = document.getElementById('attendanceList');
    const batchFilter = document.getElementById('batchFilter');
    const dateFilter = document.getElementById('dateFilter');
    const markAttendanceBtn = document.getElementById('markAttendanceBtn');

    const modal = document.getElementById('attendanceModal');
    const batchSelect = document.getElementById('batchSelect');
    const dateSelect = document.getElementById('dateSelect');
    const studentList = document.getElementById('studentList');
    const attendanceForm = document.getElementById('attendanceForm');
    const closeModalBtn = document.getElementById('closeModal');

    let unsubscribeAttendance = null;

    // Modal controls
    function showModal() { modal.classList.add('show'); }
    function hideModal() { modal.classList.remove('show'); attendanceForm.reset(); studentList.innerHTML = ''; }

    closeModalBtn.addEventListener('click', hideModal);
    markAttendanceBtn.addEventListener('click', () => {
      if (!batchFilter.value) { alert("Please select a batch first!"); return; }
      batchSelect.value = batchFilter.value;
      dateSelect.value = dateFilter.value || new Date().toISOString().split('T')[0];
      loadStudentsForBatch(batchFilter.value);
      showModal();
    });

    // Load students for a batch
    async function loadStudentsForBatch(batchName, existingMap = {}) {
      studentList.innerHTML = '';
      if (!batchName) return;
      try {
        const snaps = await getDocs(query(collection(db, 'students'), where('batch', '==', batchName)));
        if (snaps.empty) {
          studentList.innerHTML = '<div style="color:#666">No students found for this batch.</div>';
          return;
        }
        snaps.forEach(s => {
          const st = s.data();
          const id = s.id;
          const wrapper = document.createElement('div'); wrapper.className = 'student-row';

          const label = document.createElement('label');
          label.textContent = st.name;

          const select = document.createElement('select');
          select.setAttribute('data-student-id', id);
          ['Present','Absent','Late','Excused'].forEach(opt => {
            const o = document.createElement('option'); o.value = opt; o.textContent = opt; select.appendChild(o);
          });

          if (existingMap[id]) select.value = existingMap[id];

          wrapper.appendChild(label);
          wrapper.appendChild(select);
          studentList.appendChild(wrapper);
        });
      } catch (err) { console.error('loadStudentsForBatch error', err); }
    }

    // Save attendance
    attendanceForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const batch = batchSelect.value;
      const date = dateSelect.value;
      const selects = studentList.querySelectorAll('select');
      try {
        for (const select of selects) {
          const studentId = select.getAttribute('data-student-id');
          const status = select.value;
          const studentDoc = await getDoc(doc(db, 'students', studentId));
          const studentName = studentDoc.exists() ? studentDoc.data().name : 'Unknown';

          await addDoc(collection(db, 'attendance'), {
            batch: batch,
            studentId: studentId,
            studentName: studentName,
            date: date,
            status: status,
            createdAt: new Date()
          });
        }
        hideModal();
        loadAttendance(batch, date);
      } catch (err) { console.error('Error saving attendance', err); }
    });

    // Render attendance row
    function renderAttendanceRow(id, data) {
      const tr = document.createElement('tr'); tr.dataset.id = id;
      const statusClass = data.status ? `status-${data.status.toLowerCase()}` : "status-absent";
      tr.innerHTML = `
        <td>${data.date}</td>
        <td>${data.batch}</td>
        <td>${data.studentName}</td>
        <td><span class="status ${statusClass}">${data.status}</span></td>
        <td class="actions">
          <button class="btn-danger delete-btn">Delete</button>
        </td>
      `;
      tr.querySelector('.delete-btn').addEventListener('click', async () => {
        await deleteDoc(doc(db, 'attendance', id));
      });
      attendanceList.appendChild(tr);
    }

    // Load attendance with optional filters
    function loadAttendance(batch = '', date = '') {
      if (unsubscribeAttendance) unsubscribeAttendance();
      attendanceList.innerHTML = '';
      let qRef = collection(db, 'attendance');
      const clauses = [];
      if (batch) clauses.push(where('batch', '==', batch));
      if (date) clauses.push(where('date', '==', date));
      qRef = clauses.length ? query(collection(db, 'attendance'), ...clauses) : qRef;
      unsubscribeAttendance = onSnapshot(qRef, snap => {
        attendanceList.innerHTML = '';
        snap.forEach(docSnap => renderAttendanceRow(docSnap.id, docSnap.data()));
      });
    }

    // Populate batch filter
    async function loadBatchOptions() {
      const snaps = await getDocs(collection(db, 'students'));
      const batches = new Set();
      snaps.forEach(s => { if (s.data().batch) batches.add(s.data().batch); });
      batchFilter.innerHTML = '<option value="">All Batches</option>';
      batches.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b; opt.textContent = b;
        batchFilter.appendChild(opt);
      });
    }

    batchFilter.addEventListener('change', () => loadAttendance(batchFilter.value, dateFilter.value));
    dateFilter.addEventListener('change', () => loadAttendance(batchFilter.value, dateFilter.value));

    // Init
    loadBatchOptions();
    loadAttendance();
  </script>
</body>
</html>
