<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Syllabus Progress Module</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }

    .dashboard-module {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 25px;
      width: 100%;
      max-width: 950px;
    }

    h2 {
      margin: 0 0 20px 0;
      color: #1c1e21;
      border-bottom: 2px solid #e4e6eb;
      padding-bottom: 10px;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    select, button.clear-btn {
      padding: 10px 14px;
      border: 1px solid #dddfe2;
      border-radius: 6px;
      font-size: 1rem;
      outline: none;
    }

    button.clear-btn {
      background: #dc3545;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    button.clear-btn:hover {
      background: #a71d2a;
    }

    .subject-progress-card {
      border: 1px solid #e4e6eb;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
      background: #fff;
    }

    .subject-header {
      background-color: #f8f9fa;
      padding: 15px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e4e6eb;
    }

    .subject-header .arrow {
      transition: transform 0.3s ease;
    }

    .subject-progress-card.open .subject-header .arrow {
      transform: rotate(90deg);
    }

    .progress-wrapper {
      background: #e9ecef;
      border-radius: 6px;
      margin: 10px 15px;
      height: 10px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: #28a745;
      width: 0%;
      transition: width 0.4s ease;
    }
    .progress-label {
      font-size: 0.85rem;
      color: #555;
      margin: 5px 15px 10px;
    }

    .chapter-container {
      padding: 0 15px 15px 15px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out, padding 0.4s ease-out;
    }

    .subject-progress-card.open .chapter-container {
      max-height: 1000px;
      padding-top: 15px;
    }

    .chapter-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f2f5;
    }
    .chapter-row:last-child {
      border-bottom: none;
    }

    .chapter-name {
      font-weight: 500;
    }

    .status-buttons button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 16px;
      background-color: #f0f2f5;
      color: #606770;
      cursor: pointer;
      margin-left: 8px;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    .status-buttons button.active.not-started { background-color: #6c757d; color: white; border-color: #6c757d; }
    .status-buttons button.active.in-progress { background-color: #007bff; color: white; border-color: #007bff; }
    .status-buttons button.active.completed { background-color: #28a745; color: white; border-color: #28a745; }

    #message-area {
      text-align: center;
      color: #6c757d;
      padding: 30px;
      font-size: 1.1rem;
    }

    #workpool-section {
      margin-top: 30px;
      border-top: 2px solid #e4e6eb;
      padding-top: 20px;
    }
    #workpool-section h3 {
      margin-bottom: 15px;
      color: #1c1e21;
    }
    .task-card {
      padding: 12px 15px;
      margin-bottom: 12px;
      background: #f8f9fa;
      border: 1px solid #e4e6eb;
      border-radius: 6px;
    }
    .task-card strong {
      color: #007bff;
    }
  </style>
</head>
<body>

  <div class="dashboard-module">

    <nav style="background:#0d6efd; padding:12px; border-radius:8px; margin-bottom:20px; display:flex; gap:15px; flex-wrap:wrap;">
    <a href="Student Directory.html" style="color:white; text-decoration:none; ">üè´ Student Directory</a> 
    <a href="Subject manager.html" style="color:white; text-decoration:none;">üìö Subject Manager</a>
    <a href="Syllabus_progress.html" style="color:white; text-decoration:none;  font-weight:bold;">üìä Syllabus Progress</a>
    <a href="workpool.html" style="color:white; text-decoration:none;">üìù Work Pool</a>
    <a href="Dought Task.html" style="color:white; text-decoration:none;">‚ùì Doubt Box</a>
    <a href="Test Treacker.html" style="color:white; text-decoration:none;">üìò Test Tracker</a>
    <a href="Attendence.html" style="color:white; text-decoration:none;">üìÖ Attendance</a>
</nav>

    <h2>üìä Syllabus Progress</h2>

    <div class="controls">
      <label for="student-select"><b>Select Student:</b></label>
      <select id="student-select">
        <option value="">-- Choose a student --</option>
      </select>
      <button class="clear-btn" id="clear-progress">Clear Progress</button>
    </div>

    <div id="progress-container"></div>
    <div id="message-area">Please select a student to view their syllabus progress.</div>

    <div id="workpool-section" style="display:none;">
      <h3>üìù Work Pool Tasks</h3>
      <div id="workpool-tasks"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOhbm4Hgg0fhcomZfp-BpC6jfeAsshuF8",
      authDomain: "edudashboard-65a9f.firebaseapp.com",
      projectId: "edudashboard-65a9f",
      storageBucket: "edudashboard-65a9f.firebasestorage.app",
      messagingSenderId: "1007330679468",
      appId: "1:1007330679468:web:97cff4a762e9fd9df51d09"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const studentSelect = document.getElementById('student-select');
    const progressContainer = document.getElementById('progress-container');
    const messageArea = document.getElementById('message-area');
    const workpoolSection = document.getElementById('workpool-section');
    const workpoolTasks = document.getElementById('workpool-tasks');
    const clearBtn = document.getElementById('clear-progress');

    let currentStudentId = null;
    let unsubscribeSyllabusListener = null;
    let unsubscribeWorkPoolListener = null;

    async function loadStudents() {
      try {
        const snapshot = await db.collection('students').get();
        if (snapshot.empty) {
          studentSelect.innerHTML = '<option value="">-- No students found --</option>';
          return;
        }
        studentSelect.innerHTML = '<option value="">-- Choose a student --</option>';
        snapshot.docs.forEach(doc => {
          const student = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = student.name;
          studentSelect.appendChild(option);
        });
      } catch (error) {
        console.error("Error loading students: ", error);
        messageArea.textContent = "Error: Could not load students.";
      }
    }

    async function loadSyllabusAndProgress(studentId) {
      messageArea.textContent = 'Loading syllabus...';
      messageArea.style.display = 'block';
      progressContainer.innerHTML = '';
      workpoolTasks.innerHTML = '';
      workpoolSection.style.display = "none";

      try {
        const syllabusDoc = await db.collection('subjectAssignments').doc(studentId).get();
        if (!syllabusDoc.exists || !syllabusDoc.data().subjects) {
          messageArea.textContent = 'No subjects have been assigned to this student yet.';
          return;
        }
        const subjects = syllabusDoc.data().subjects;

        if (unsubscribeSyllabusListener) unsubscribeSyllabusListener();
        unsubscribeSyllabusListener = db.collection('syllabusProgress').doc(studentId)
          .onSnapshot(progressDoc => {
            const progressData = progressDoc.exists ? progressDoc.data().chapters : {};
            renderProgressView(subjects, progressData);
            messageArea.style.display = 'none';
          });

        if (unsubscribeWorkPoolListener) unsubscribeWorkPoolListener();
        unsubscribeWorkPoolListener = db.collection('workPool')
          .where('studentId', '==', studentId)
          .onSnapshot(snapshot => {
            workpoolTasks.innerHTML = '';
            if (snapshot.empty) {
              workpoolSection.style.display = "none";
              return;
            }
            snapshot.docs.forEach(doc => {
              const task = doc.data();
              const taskDiv = document.createElement('div');
              taskDiv.className = 'task-card';
              taskDiv.innerHTML = `
                <strong>${task.subject} - ${task.chapter}</strong><br>
                ${task.description}<br>
                <small>Due: ${task.dueDate.toDate().toLocaleDateString()} | Status: ${task.status}</small>
              `;
              workpoolTasks.appendChild(taskDiv);
            });
            workpoolSection.style.display = "block";
          });

      } catch (error) {
        console.error("Error loading syllabus: ", error);
        messageArea.textContent = "Error: Could not load the student's syllabus.";
      }
    }

    function renderProgressView(subjects, progressData) {
      progressContainer.innerHTML = '';
      subjects.forEach(subject => {
        if (!subject.chapters || subject.chapters.length === 0) return;

        const total = subject.chapters.length;
        const completed = subject.chapters.filter(chapter => {
          const key = `${subject.name}_${chapter}`.replace(/\s+/g, '_');
          return progressData[key]?.status === "Completed";
        }).length;
        const percent = Math.round((completed / total) * 100);

        const card = document.createElement('div');
        card.className = 'subject-progress-card';
        
        let chapterRowsHtml = '';
        subject.chapters.forEach(chapter => {
          const chapterKey = `${subject.name}_${chapter}`.replace(/\s+/g, '_');
          const currentStatus = progressData[chapterKey]?.status || 'Not Started';

          chapterRowsHtml += `
            <div class="chapter-row" data-subject="${subject.name}" data-chapter="${chapter}" data-key="${chapterKey}">
              <span class="chapter-name">${chapter}</span>
              <div class="status-buttons">
                <button class="status-btn not-started ${currentStatus === 'Not Started' ? 'active' : ''}" data-status="Not Started">Start</button>
                <button class="status-btn in-progress ${currentStatus === 'In Progress' ? 'active' : ''}" data-status="In Progress">In Progress</button>
                <button class="status-btn completed ${currentStatus === 'Completed' ? 'active' : ''}" data-status="Completed">Finish</button>
              </div>
            </div>
          `;
        });

        card.innerHTML = `
          <div class="subject-header">
            <span>${subject.name}</span>
            <span class="arrow">‚ñ∂</span>
          </div>
          <div class="progress-wrapper"><div class="progress-bar" style="width:${percent}%"></div></div>
          <div class="progress-label">${completed}/${total} chapters completed (${percent}%)</div>
          <div class="chapter-container">${chapterRowsHtml}</div>
        `;
        progressContainer.appendChild(card);
      });
      addEventListeners();
    }

    async function updateChapterStatus(chapterKey, newStatus, subject, chapter) {
      if (!currentStudentId) return;
      const docRef = db.collection('syllabusProgress').doc(currentStudentId);

      try {
        await docRef.set({
          chapters: {
            [chapterKey]: { status: newStatus }
          }
        }, { merge: true });

        // Auto-create task when starting (In Progress)
        if (newStatus === 'In Progress') {
          await createWorkPoolTask(currentStudentId, subject, chapter);
        }
      } catch (error) {
        console.error("Error updating status: ", error);
        alert("Failed to update progress.");
      }
    }

    async function createWorkPoolTask(studentId, subject, chapter) {
      const workPoolRef = db.collection('workPool');
      const querySnapshot = await workPoolRef
        .where('studentId', '==', studentId)
        .where('subject', '==', subject)
        .where('chapter', '==', chapter)
        .limit(1)
        .get();

      if (!querySnapshot.empty) return;

      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 7);

      const newTask = {
        studentId,
        subject,
        chapter,
        description: `Complete exercises and review notes for ${chapter}.`,
        dueDate: firebase.firestore.Timestamp.fromDate(dueDate),
        status: "To Do",
        priority: "Medium",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await workPoolRef.add(newTask);
      } catch (error) {
        console.error("Error creating work pool task: ", error);
      }
    }

    function addEventListeners() {
      document.querySelectorAll('.subject-header').forEach(header => {
        header.addEventListener('click', () => {
          header.parentElement.classList.toggle('open');
        });
      });

      document.querySelectorAll('.status-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const chapterRow = e.target.closest('.chapter-row');
          const { subject, chapter, key } = chapterRow.dataset;
          const newStatus = e.target.dataset.status;
          if (e.target.classList.contains('active')) return;
          updateChapterStatus(key, newStatus, subject, chapter);
        });
      });
    }

    clearBtn.addEventListener('click', async () => {
      if (!currentStudentId) {
        alert("Select a student first!");
        return;
      }
      if (!confirm("Are you sure you want to clear this student's progress and tasks?")) return;

      try {
        await db.collection('syllabusProgress').doc(currentStudentId).delete();
        const tasks = await db.collection('workPool').where('studentId', '==', currentStudentId).get();
        const batch = db.batch();
        tasks.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("Progress and tasks cleared!");
      } catch (error) {
        console.error("Error clearing data: ", error);
      }
    });

    document.addEventListener('DOMContentLoaded', loadStudents);
    studentSelect.addEventListener('change', (e) => {
      currentStudentId = e.target.value;
      if (currentStudentId) {
        loadSyllabusAndProgress(currentStudentId);
      } else {
        if (unsubscribeSyllabusListener) unsubscribeSyllabusListener();
        if (unsubscribeWorkPoolListener) unsubscribeWorkPoolListener();
        progressContainer.innerHTML = '';
        workpoolTasks.innerHTML = '';
        workpoolSection.style.display = "none";
        messageArea.textContent = 'Please select a student to view their syllabus progress.';
        messageArea.style.display = 'block';
      }
    });
  </script>
</body>
</html>
